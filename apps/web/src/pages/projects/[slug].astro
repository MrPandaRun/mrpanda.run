---
import AuthorCard from "@/components/AuthorCard.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getSortedBlogPosts, getSortedProjects, type ProjectEntry } from "@/lib/content";
import { formatDate } from "@/lib/date";

const slug = Astro.params.slug ?? "";
const allProjects = await getSortedProjects();
const project = allProjects.find((entry) => entry.slug === slug);

if (!project) {
  Astro.response.status = 404;
}

const allPosts = await getSortedBlogPosts();

const relatedPosts = project
  ? project.data.relatedPosts
      .map((postSlug) => allPosts.find((post) => post.slug === postSlug))
      .filter((post): post is (typeof allPosts)[number] => Boolean(post))
  : [];

const statusLabel: Record<ProjectEntry["data"]["status"], string> = {
  "in-progress": "in progress",
  shipped: "shipped",
  archived: "archived"
};

const pageTitle = project ? project.data.title : "Project Not Found";
const pageDescription = project ? project.data.problem : "This project may have been moved or removed.";
---

<BaseLayout title={pageTitle} description={pageDescription} noIndex={!project}>
  {
    project ? (
      <article class="page-shell space-y-8 py-10 md:py-14">
        <header class="max-w-4xl fade-rise">
          <p class="section-kicker">Project Detail</p>
          <h1 class="page-title mt-4">{project.data.title}</h1>
          <div class="mt-4 flex flex-wrap items-center gap-3 text-sm text-ink/62">
            <span class="rounded-full border border-line bg-paper px-2 py-1 uppercase tracking-[0.12em]">
              {statusLabel[project.data.status]}
            </span>
            <span>Updated {formatDate(project.data.updatedAt)}</span>
          </div>
          <div class="mt-4 flex flex-wrap gap-2">
            {project.data.stack.map((item) => (
              <span class="rounded-full border border-line bg-paper px-2 py-1 text-xs text-ink/58">{item}</span>
            ))}
          </div>
        </header>

        <AuthorCard
          description="I document assumptions, build decisions, and measurable outcomes in public."
          className="max-w-4xl fade-rise delay-1"
        />

        <section class="grid gap-6 lg:grid-cols-[1.2fr_1fr]">
          <article class="rounded-2xl border border-line/80 bg-paper/95 p-6 fade-rise delay-1">
            <h2 class="font-display text-3xl text-ink">Overview</h2>
            <p class="mt-3 text-sm leading-7 text-ink/72">{project.data.problem}</p>
            <div class="mt-5 flex flex-wrap gap-3">
              <a
                href={project.data.demoUrl}
                target="_blank"
                rel="noreferrer"
                class="rounded-full border border-accent/60 bg-accent px-4 py-2 text-sm text-paper transition hover:-translate-y-0.5 hover:bg-coral"
              >
                Open Demo
              </a>
              <a
                href={project.data.repoUrl}
                target="_blank"
                rel="noreferrer"
                class="rounded-full border border-line bg-paper px-4 py-2 text-sm text-ink/75 transition hover:-translate-y-0.5"
              >
                GitHub Repo
              </a>
            </div>
          </article>

          <article class="rounded-2xl border border-line/80 bg-paper/95 p-6 fade-rise delay-2">
            <h2 class="font-display text-3xl text-ink">Problem & Hypothesis</h2>
            <p class="mt-3 text-sm leading-7 text-ink/72">{project.data.hypothesis}</p>
          </article>
        </section>

        <section class="grid gap-6 md:grid-cols-2">
          <article class="rounded-2xl border border-line/80 bg-paper/95 p-6 fade-rise delay-2">
            <h2 class="font-display text-3xl text-ink">Build Process</h2>
            <ul class="mt-4 space-y-3 text-sm leading-7 text-ink/72">
              {project.data.buildProcess.map((item) => (
                <li class="flex gap-2">
                  <span aria-hidden="true" class="text-accent">•</span>
                  <span>{item}</span>
                </li>
              ))}
            </ul>
          </article>

          <article class="rounded-2xl border border-line/80 bg-paper/95 p-6 fade-rise delay-3">
            <h2 class="font-display text-3xl text-ink">Results & Metrics</h2>
            <ul class="mt-4 space-y-3 text-sm leading-7 text-ink/72">
              {project.data.resultsMetrics.map((item) => (
                <li class="flex gap-2">
                  <span aria-hidden="true" class="text-accent">✓</span>
                  <span>{item}</span>
                </li>
              ))}
            </ul>
          </article>
        </section>

        <section class="grid gap-6 lg:grid-cols-[1fr_1fr]">
          <article class="rounded-2xl border border-line/80 bg-paper/95 p-6 fade-rise delay-3">
            <h2 class="font-display text-3xl text-ink">Retrospective</h2>
            <ul class="mt-4 space-y-3 text-sm leading-7 text-ink/72">
              {project.data.retrospective.map((item) => (
                <li class="flex gap-2">
                  <span aria-hidden="true" class="text-coral">↺</span>
                  <span>{item}</span>
                </li>
              ))}
            </ul>
          </article>

          <article class="rounded-2xl border border-line/80 bg-paper/95 p-6 fade-rise delay-3">
            <h2 class="font-display text-3xl text-ink">Links</h2>
            <div class="mt-4 space-y-3 text-sm">
              <a
                href={project.data.demoUrl}
                target="_blank"
                rel="noreferrer"
                class="block rounded-xl border border-line bg-canvas/20 px-4 py-3 text-ink/75 transition hover:bg-paper"
              >
                Demo
              </a>
              <a
                href={project.data.repoUrl}
                target="_blank"
                rel="noreferrer"
                class="block rounded-xl border border-line bg-canvas/20 px-4 py-3 text-ink/75 transition hover:bg-paper"
              >
                GitHub
              </a>
              {relatedPosts.map((post) => (
                <a
                  href={`/blog/${post.slug}`}
                  class="block rounded-xl border border-line bg-canvas/20 px-4 py-3 text-ink/75 transition hover:bg-paper"
                >
                  Related post: {post.data.title}
                </a>
              ))}
            </div>
          </article>
        </section>
      </article>
    ) : (
      <section class="page-shell py-20">
        <p class="section-kicker">404</p>
        <h1 class="page-title mt-4">Project Not Found</h1>
        <p class="mt-4 max-w-xl text-ink/70">This link may be outdated. Go back to the project list.</p>
        <div class="mt-8 flex flex-wrap gap-3">
          <a
            href="/projects"
            class="rounded-full border border-line bg-paper px-4 py-2 text-sm text-ink/75 transition hover:-translate-y-0.5"
          >
            Back to Projects
          </a>
          <a
            href="/"
            class="rounded-full border border-accent/60 bg-accent px-4 py-2 text-sm text-paper transition hover:-translate-y-0.5"
          >
            Home
          </a>
        </div>
      </section>
    )
  }
</BaseLayout>
