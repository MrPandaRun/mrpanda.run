---
import { render } from "astro:content";
import AuthorCard from "@/components/AuthorCard.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getRelatedPosts, getSortedBlogPosts, type BlogEntry } from "@/lib/content";
import { formatDate } from "@/lib/date";

const slug = Astro.params.slug ?? "";
const allPosts = await getSortedBlogPosts();
const post = allPosts.find((entry) => entry.slug === slug);

if (!post) {
  Astro.response.status = 404;
}

const categoryLabel: Record<BlogEntry["data"]["category"], string> = {
  learn: "Learn",
  build: "Build",
  think: "Think"
};

const relatedPosts = post ? getRelatedPosts(allPosts, post, 2) : [];
const rendered = post ? await render(post) : null;
const tocItems = rendered
  ? rendered.headings.filter((heading) => heading.depth === 2)
  : [];

const pageTitle = post ? post.data.title : "Post Not Found";
const pageDescription = post ? post.data.summary : "This post may have been moved or removed.";
---

<BaseLayout title={pageTitle} description={pageDescription} noIndex={!post}>
  {
    post && rendered ? (
      <article class="page-shell space-y-10 py-10 md:py-14">
        <header class="max-w-4xl fade-rise">
          <p class="section-kicker">Blog Detail</p>
          <h1 class="page-title mt-4">{post.data.title}</h1>
          <div class="mt-5 flex flex-wrap items-center gap-3 text-sm text-ink/60">
            <time datetime={post.data.publishedAt.toISOString()}>{formatDate(post.data.publishedAt)}</time>
            <span>·</span>
            <span>{post.data.readTime}</span>
            <span>·</span>
            <span>{categoryLabel[post.data.category]}</span>
          </div>
          <div class="mt-4 flex flex-wrap gap-2">
            {post.data.tags.map((tag) => (
              <span class="rounded-full border border-line bg-paper px-2 py-1 text-xs text-ink/55">#{tag}</span>
            ))}
          </div>
        </header>

        <AuthorCard
          description="I share practical AI learnings, trade-offs, and next steps from real builds."
          className="max-w-4xl fade-rise delay-1"
        />

        <div class="grid gap-10 lg:grid-cols-[220px_1fr]">
          <aside class="fade-rise delay-1 h-fit rounded-2xl border border-line/80 bg-paper/90 p-4 lg:sticky lg:top-24">
            <h2 class="text-xs uppercase tracking-[0.16em] text-ink/50">Table of Contents</h2>
            <nav class="mt-3" aria-label="Table of contents">
              {
                tocItems.length > 0 ? (
                  <ul class="space-y-2 text-sm text-ink/72">
                    {tocItems.map((item) => (
                      <li>
                        <a href={`#${item.slug}`} class="block rounded px-2 py-1 transition hover:bg-canvas/30">
                          {item.text}
                        </a>
                      </li>
                    ))}
                  </ul>
                ) : (
                  <p class="text-sm text-ink/65">No section headings in this post.</p>
                )
              }
            </nav>
          </aside>

          <div class="space-y-8">
            <div class="article-prose rounded-3xl border border-line/80 bg-paper/95 p-6 shadow-card fade-rise delay-1">
              <rendered.Content />
            </div>

            <section class="rounded-2xl border border-line/80 bg-paper/95 p-6 fade-rise delay-2">
              <h2 class="font-display text-3xl text-ink">Next Action</h2>
              <ul class="mt-4 space-y-2 text-sm leading-7 text-ink/75">
                {post.data.nextAction.map((item) => (
                  <li class="flex gap-2">
                    <span aria-hidden="true" class="text-accent">→</span>
                    <span>{item}</span>
                  </li>
                ))}
              </ul>
            </section>

            <section class="rounded-2xl border border-line/80 bg-paper/95 p-6 fade-rise delay-2">
              <h2 class="font-display text-3xl text-ink">Related Posts</h2>
              <div class="mt-4 grid gap-3 md:grid-cols-2">
                {relatedPosts.length > 0 ? (
                  relatedPosts.map((item) => (
                    <a
                      href={`/blog/${item.slug}`}
                      class="rounded-xl border border-line/80 bg-canvas/20 p-4 transition hover:-translate-y-0.5"
                    >
                      <p class="text-xs uppercase tracking-[0.14em] text-ink/50">{categoryLabel[item.data.category]}</p>
                      <h3 class="mt-2 text-lg font-medium text-ink">{item.data.title}</h3>
                      <p class="mt-2 text-sm text-ink/65">{item.data.summary}</p>
                    </a>
                  ))
                ) : (
                  <p class="text-sm text-ink/65">More posts are being prepared.</p>
                )}
              </div>
            </section>

            <section class="rounded-2xl border border-accent/40 bg-gradient-to-br from-paper via-canvas/30 to-paper p-6 fade-rise delay-3">
              <h2 class="font-display text-3xl text-ink">Get Weekly Action Steps</h2>
              <p class="mt-2 text-sm leading-7 text-ink/70">
                Subscribe to get 3 weekly actions, one real project postmortem, and reusable resources.
              </p>
              <a
                href="/subscribe"
                data-track-event="blog_subscribe_click"
                data-track-payload={JSON.stringify({
                  source: "blog_detail",
                  slug: post.slug
                })}
                class="mt-5 inline-flex items-center rounded-full border border-accent/60 bg-accent px-5 py-2 text-sm font-medium text-paper transition hover:-translate-y-0.5 hover:bg-coral"
              >
                Subscribe
              </a>
            </section>
          </div>
        </div>
      </article>
    ) : (
      <section class="page-shell py-20">
        <p class="section-kicker">404</p>
        <h1 class="page-title mt-4">Post Not Found</h1>
        <p class="mt-4 max-w-xl text-ink/70">This link may be outdated. Go back to the blog list and continue reading.</p>
        <div class="mt-8 flex flex-wrap gap-3">
          <a
            href="/blog"
            class="rounded-full border border-line bg-paper px-4 py-2 text-sm text-ink/75 transition hover:-translate-y-0.5"
          >
            Back to Blog
          </a>
          <a
            href="/"
            class="rounded-full border border-accent/60 bg-accent px-4 py-2 text-sm text-paper transition hover:-translate-y-0.5"
          >
            Home
          </a>
        </div>
      </section>
    )
  }
</BaseLayout>
